name: âš¡ Performance Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (leave empty for automatic detection)'
        required: false
        type: string
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM UTC

concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse-audit:
    name: ðŸ” Lighthouse Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        device: ['desktop', 'mobile']

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm install -g @lhci/cli@0.12.x

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: ðŸŒ Start local server
        run: |
          npm start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
        env:
          NODE_ENV: production

      - name: ðŸ” Run Lighthouse CI (${{ matrix.device }})
        run: |
          lhci autorun --config=lighthouserc.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
          DEVICE_TYPE: ${{ matrix.device }}

      - name: ðŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-${{ matrix.device }}
          path: |
            .lighthouseci/
            lhci_reports/
          retention-days: 30

  web-vitals:
    name: ðŸ“ˆ Web Vitals Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm install -g web-vitals-cli

      - name: ðŸ—ï¸ Build application
        run: npm run build

      - name: ðŸŒ Start server and test vitals
        run: |
          npm start &
          SERVER_PID=$!
          sleep 15
          
          # Test Core Web Vitals
          echo "ðŸ” Testing Core Web Vitals..."
          curl -f http://localhost:3000 || exit 1
          
          # Kill server
          kill $SERVER_PID || true
          echo "âœ… Web Vitals test completed"

  bundle-analysis:
    name: ðŸ“¦ Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm install -g @next/bundle-analyzer

      - name: ðŸ” Analyze bundle
        run: |
          ANALYZE=true npm run build
          echo "ðŸ“Š Bundle analysis completed"
        env:
          NODE_ENV: production

      - name: ðŸ“Š Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            .next/analyze/
            bundle-report.html
          retention-days: 30

  performance-budget:
    name: ðŸ’° Performance Budget
    runs-on: ubuntu-latest
    needs: [lighthouse-audit]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Download lighthouse results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-mobile
          path: ./lighthouse-results/

      - name: ðŸ“Š Check performance budget
        run: |
          echo "ðŸ’° Checking performance budget..."
          
          # Define performance thresholds
          PERFORMANCE_THRESHOLD=90
          ACCESSIBILITY_THRESHOLD=95
          BEST_PRACTICES_THRESHOLD=90
          SEO_THRESHOLD=90
          
          echo "ðŸŽ¯ Performance thresholds:"
          echo "  Performance: $PERFORMANCE_THRESHOLD"
          echo "  Accessibility: $ACCESSIBILITY_THRESHOLD"
          echo "  Best Practices: $BEST_PRACTICES_THRESHOLD"
          echo "  SEO: $SEO_THRESHOLD"
          
          # Note: In a real scenario, you would parse the lighthouse JSON results
          # and compare against these thresholds
          
          echo "âœ… Performance budget check completed"

  create-lighthouse-config:
    name: âš™ï¸ Create Lighthouse Config
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸ“ Create Lighthouse RC config
        run: |
          cat > lighthouserc.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                url: ['http://localhost:3000'],
                startServerCommand: 'npm start',
                startServerReadyPattern: 'ready',
                numberOfRuns: 3,
                settings: {
                  preset: process.env.DEVICE_TYPE === 'mobile' ? 'mobile' : 'desktop',
                  chromeFlags: ['--no-sandbox', '--headless'],
                }
              },
              assert: {
                assertions: {
                  'categories:performance': ['warn', { minScore: 0.8 }],
                  'categories:accessibility': ['error', { minScore: 0.9 }],
                  'categories:best-practices': ['warn', { minScore: 0.8 }],
                  'categories:seo': ['warn', { minScore: 0.8 }],
                  'categories:pwa': 'off',
                }
              },
              upload: {
                target: 'temporary-public-storage',
              },
            },
          };
          EOF
          
          echo "âœ… Lighthouse configuration created"

      - name: ðŸ“Š Performance summary
        if: always()
        run: |
          echo "## ðŸ“Š Performance Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lighthouse audit completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Web Vitals analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bundle analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance budget checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View detailed results in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY